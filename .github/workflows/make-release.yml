name: Make release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

jobs:
  build-binaries:
    needs:
    - create-tag

    strategy:
      matrix:
        include:
        - os: windows
          arch: amd64
        - os: linux
          arch: amd64
        - os: darwin
          arch: arm64

    runs-on: ubuntu-22.04
    
    env:
      GOOS: ${{ matrix.os }}
      GOARCH: ${{ matrix.arch }}

    steps:

    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23.1'
    
    - name: Build binary
      shell: bash
      run: | 
        mkdir -p artifacts
        suffix="${{ matrix.os }}-${{ matrix.arch }}"
        if [[ "${{ matrix.os }}" == "windows" ]]; then
          suffix="$suffix.exe"
        fi
        go build -o "artifacts/cti-$suffix" ./cmd/cti/cti.go

    - name: Upload release
      id: upload_release
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const path = require('path');
          const fs = require('fs');
          const { ref } = github.context;
          const { data: { id: releaseId } } = await github.rest.repos.getReleaseByTag({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag: ref.replace('refs/tags/', ''),
          });
          const root = './artifacts';
          const release_id = '${{ needs.create-tag.outputs.release_id }}';
          const files = fs.readdirSync(root);
          for (const file of files) {
            console.log('uploadReleaseAsset', file);
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release_id,
              name: file,
              data: fs.readFileSync(path.join(root, file))
            });
          }
